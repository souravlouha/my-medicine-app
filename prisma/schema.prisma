generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. USER & AUTHENTICATION
// ==========================================
model User {
  id            String   @id @default(uuid())
  publicId      String?  @unique
   
  name          String
  email         String   @unique
  password      String
  role          Role     @default(MANUFACTURER)
   
  // üè¢ Company Profile
  licenseNo     String?  
  licenseExp    DateTime?
  address       String?
  phone         String?
  geoLat        Float?     
  geoLng        Float?

  // ‚úÖ NEW: Operator Management (Boss-Worker Relationship)
  // ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶§‡¶æ ‡¶¨‡ßã‡¶ù‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
  ownerId       String?   
  owner         User?     @relation("OwnerWorker", fields: [ownerId], references: [id])
  workers       User[]    @relation("OwnerWorker")

  // üîó Relations
  products            Product[]    @relation("ProductOwner")
  batches             Batch[]      @relation("BatchCreator")
   
  // ‚úÖ NEW: Relation for Print Jobs (Assignee/Operator)
  assignedPrintJobs   PrintJob[]   @relation("JobOperator")

  // üìâ Dashboard Data Sources
  inventory           Inventory[]  
  sales               SalesRecord[] 
   
  // üöö Supply Chain
  sentShipments       Shipment[]   @relation("Sender")
  receivedShipments   Shipment[]   @relation("Receiver")
   
  // üÜï B2B Ordering
  placedOrders        Order[]       @relation("PlacedOrders")   // Orders I placed
  receivedOrders      Order[]       @relation("ReceivedOrders") // Orders I received

  // üîî Alerts & Actions
  notifications       Notification[] 
  returnsSent         Return[]      @relation("ReturnSender")
  returnsReceived     Return[]      @relation("ReturnReceiver")
  auditLogs           AuditLog[]    

  // üî• Activity Log
  activityLogs        ActivityLog[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

enum Role {
  MANUFACTURER
  DISTRIBUTOR
  RETAILER
  ADMIN
  CONSUMER
  OPERATOR  // ‚úÖ NEW: Added for Factory Workers
}

// ==========================================
// 2. PRODUCT CATALOG (Master Data)
// ==========================================
model Product {
  id              String   @id @default(uuid())
   
  productCode     String   @unique 
  basePrice       Float?    
   
  name            String    
  genericName     String?   
  strength        String?   
  type            MedicineType 
   
  storageTemp     String?   
  isNarcotic      Boolean  @default(false) 
   
  manufacturerId  String
  manufacturer    User     @relation("ProductOwner", fields: [manufacturerId], references: [id])
   
  batches         Batch[]
  orderItems      OrderItem[] 

  createdAt       DateTime @default(now())
}

enum MedicineType {
  TABLET
  CAPSULE
  SYRUP
  INJECTION
  CREAM
  DROPS
}

// ==========================================
// 3. BATCH & PRODUCTION
// ==========================================
model Batch {
  id              String   @id @default(uuid())
  batchNumber     String   @unique 
   
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
   
  manufacturerId  String
  manufacturer    User     @relation("BatchCreator", fields: [manufacturerId], references: [id])
   
  mfgDate         DateTime
  expDate         DateTime 
   
  mrp             Float
  totalQuantity   Int         
   
  // üîó Tracking
  inventory       Inventory[]
  units           Unit[]
  shipmentItems   ShipmentItem[]
   
  // ‚úÖ NEW: Relation to Print Jobs
  printJobs       PrintJob[]

  // üÜï Hierarchy Tracking Relation
  movements       BatchMovement[] 
   
  salesRecords    SalesRecord[] 
  recalls         Recall[] 

  createdAt       DateTime @default(now())
}

// ==========================================
// 4. INVENTORY
// ==========================================
model Inventory {
  id              String   @id @default(uuid())
   
  userId          String    
  user            User     @relation(fields: [userId], references: [id])
   
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
   
  currentStock    Int         
   
  updatedAt       DateTime @updatedAt

  @@unique([userId, batchId]) 
}

// ==========================================
// 5. UNIT / QR HIERARCHY
// ==========================================
model Unit {
  id              String   @id @default(uuid())
  uid             String   @unique 
  type            UnitType 
   
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])

  parentId        String?   
  parent          Unit?    @relation("UnitHierarchy", fields: [parentId], references: [id])
  children        Unit[]   @relation("UnitHierarchy")

  status          UnitStatus @default(CREATED)
  currentHandlerId String?    
   
  scans           ScanHistory[]

  createdAt       DateTime @default(now())
}

enum UnitType {
  CARTON
  BOX
  STRIP
}

enum UnitStatus {
  CREATED
  IN_TRANSIT
  RECEIVED
  SOLD
  RECALLED
  EXPIRED
  RETURNED
  DAMAGED
}

// ==========================================
// 6. SHIPMENT & LOGISTICS
// ==========================================
model Shipment {
  id              String   @id @default(uuid())
  shipmentId      String?  @unique 
   
  manufacturerId  String
  sender          User     @relation("Sender", fields: [manufacturerId], references: [id])
   
  distributorId   String
  receiver        User     @relation("Receiver", fields: [distributorId], references: [id])
   
  items           ShipmentItem[]
   
  status          ShipmentStatus @default(IN_TRANSIT)
  totalAmount     Float
   
  vehicleNo       String?
  driverPhone     String?
  expectedDelivery DateTime?
   
  createdAt       DateTime @default(now())
  receivedAt      DateTime?
}

model ShipmentItem {
  id          String   @id @default(uuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id])
   
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id])
   
  quantity    Int
  price       Float
}

enum ShipmentStatus {
  IN_TRANSIT
  DELIVERED
  CANCELLED
  REJECTED
}

// ==========================================
// 7. B2B ORDER MANAGEMENT
// ==========================================
model Order {
  id              String   @id @default(uuid())
  orderId         String   @unique 
   
  senderId        String    
  sender          User     @relation("PlacedOrders", fields: [senderId], references: [id])
   
  receiverId      String    
  receiver        User     @relation("ReceivedOrders", fields: [receiverId], references: [id])

  totalAmount     Float
  status          OrderStatus @default(PENDING)
   
  items           OrderItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model OrderItem {
  id          String @id @default(uuid())
  orderId     String
  order       Order  @relation(fields: [orderId], references: [id])
   
  productId   String
  product     Product @relation(fields: [productId], references: [id])
   
  quantity    Int
  price       Float    
}

enum OrderStatus {
  PENDING
  APPROVED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ==========================================
// 8. SALES & ANALYTICS
// ==========================================
model SalesRecord {
  id              String   @id @default(uuid())
   
  sellerId        String    
  seller          User     @relation(fields: [sellerId], references: [id])
   
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
   
  quantity        Int         
  totalPrice      Float       
  buyerType       String?     
   
  date            DateTime @default(now())

  @@index([sellerId, date]) 
}

// ==========================================
// 9. NOTIFICATIONS & ALERTS
// ==========================================
model Notification {
  id        String   @id @default(uuid())
   
  userId    String
  user      User     @relation(fields: [userId], references: [id])
   
  title     String    
  message   String    
  type      NotifType 
  isRead    Boolean  @default(false)
   
  createdAt DateTime @default(now())
}

enum NotifType {
  INFO      
  WARNING   
  ALERT       
}

// ==========================================
// 10. RECALL & RETURNS
// ==========================================
model Recall {
  id              String   @id @default(uuid())
   
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
   
  reason          String    
  issuedBy        String    
   
  severity        String   @default("MEDIUM") 
  actionType      String   @default("RETURN") 
   
  status          String   @default("ACTIVE") 
  resolvedAt      DateTime? 
   
  createdAt       DateTime @default(now())
}

model Return {
  id              String   @id @default(uuid())
   
  senderId        String
  sender          User     @relation("ReturnSender", fields: [senderId], references: [id])
   
  receiverId      String
  receiver        User     @relation("ReturnReceiver", fields: [receiverId], references: [id])
   
  batchId         String    
  quantity        Int
  reason          String    
  status          String    @default("PENDING") 
   
  createdAt       DateTime @default(now())
}

// ==========================================
// 11. PUBLIC SCAN & FRAUD DETECTION
// ==========================================
model ScanHistory {
  id              String   @id @default(uuid())
  unitId          String
  unit            Unit     @relation(fields: [unitId], references: [id])
   
  ipAddress       String?
  location        String?   
  device          String?   
   
  scannedAt       DateTime @default(now())
  isSuspicious    Boolean @default(false) 
}

// ==========================================
// 12. AUDIT LOGS (Security)
// ==========================================
model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
   
  action    String    
  details   String?
  ipAddress String?
   
  timestamp DateTime @default(now())
}

// ==========================================
// 13. GLOBAL SUPPLY CHAIN TRACKING
// ==========================================
model BatchMovement {
  id                  String           @id @default(uuid())
   
  batchId             String
  batch               Batch            @relation(fields: [batchId], references: [id])
   
  senderId            String
  receiverId          String?           
   
  senderName          String
  receiverName        String
   
  role                Role              
  quantity            Int
  status              String           @default("DELIVERED") 
  location            String?
   
  parentId            String?           
  parent              BatchMovement?  @relation("MovementHierarchy", fields: [parentId], references: [id])
  children            BatchMovement[] @relation("MovementHierarchy")

  createdAt           DateTime        @default(now())

  @@index([batchId])
  @@index([parentId])
}

// ==========================================
// 14. ACTIVITY LOG
// ==========================================
model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  details   String
  createdAt DateTime @default(now())

  @@index([userId])
}

// ==========================================
// 15. PRODUCTION & PRINT JOBS (NEW)
// ==========================================
model PrintJob {
  id               String       @id @default(uuid())
  jobId            String       @unique // e.g., JOB-2026-001
   
  batchId          String
  batch            Batch        @relation(fields: [batchId], references: [id])
   
  // ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶¨‡ßã
  operatorId       String?      
  operator         User?        @relation("JobOperator", fields: [operatorId], references: [id])
   
  machineName      String?      // e.g., "Line-1 Printer"
   
  targetQuantity   Int          // Total codes to print (e.g., 10,000)
  printedQuantity  Int          @default(0) // Successful prints
   
  status           String       @default("PENDING") // PENDING, PRINTING, COMPLETED
   
  // üîê Security Fields (Time-Bound Access)
  accessCode       String?      @unique  // 6-digit code
  accessExpiresAt  DateTime?             // Expiry Time
   
  createdAt        DateTime     @default(now())
}